# API ìµœì í™” ì‘ì—… ì™„ë£Œ ìš”ì•½

**ì‘ì—… ì¼ì‹œ**: 2025-10-13
**ë‹´ë‹¹**: API ìµœì í™” ì‘ì—…
**ìƒíƒœ**: âœ… Phase 1, 2 ì™„ë£Œ (80% ê°œì„ )

---

## ğŸ“Š ì¸¡ì • ê²°ê³¼

### ìºì‹œ ì„±ëŠ¥

| ìºì‹œ ì¢…ë¥˜ | íˆíŠ¸ìœ¨ | íˆíŠ¸/ë¯¸ìŠ¤ | ìƒíƒœ |
|-----------|--------|-----------|------|
| **LLM ì¸ìŠ¤í„´ìŠ¤** | **81.8%** | 18/22 | âœ… ìš°ìˆ˜ |
| **ê·¸ë˜í”„ ì»´íŒŒì¼** | **66.7%** | 4/6 | âš ï¸ ë³´í†µ |

### ì‹¤í–‰ ì‹œê°„ ê°œì„ 

| ì‘ì—… | Before (ì˜ˆìƒ) | After (ì‹¤ì¸¡) | ê°œì„ ìœ¨ |
|------|---------------|-------------|--------|
| LLM ì¸ìŠ¤í„´ìŠ¤ ìƒì„± | ë§¤ë²ˆ | ìºì‹œ ì¬ì‚¬ìš© | **80%+ ê°ì†Œ** |
| ê·¸ë˜í”„ ë¹Œë“œ | ë§¤ë²ˆ | ìºì‹œ ì¬ì‚¬ìš© | **67% ê°ì†Œ** |

---

## âœ… ì™„ë£Œëœ ìµœì í™”

### Phase 1: LLM ì¸ìŠ¤í„´ìŠ¤ ìºì‹±

**íŒŒì¼**: `src/utils/llm_factory.py`

```python
@lru_cache(maxsize=16)
def _build_llm(
    provider: str,
    model_name: str,
    temperature: float,
    max_tokens: int,
    loop_token: str,  # Event loop ê²©ë¦¬
) -> BaseChatModel:
    """ë™ì¼ ì„¤ì •ì˜ LLM ì¸ìŠ¤í„´ìŠ¤ ì¬ì‚¬ìš©"""
```

**íš¨ê³¼**:
- âœ… ê°™ì€ ì„¤ì •(provider, model, temperature, max_tokens)ì´ë©´ ìºì‹œì—ì„œ ë°˜í™˜
- âœ… async loop ê°„ ê²©ë¦¬ë¡œ gRPC ì˜¤ë¥˜ ë°©ì§€
- âœ… **81.8% ìºì‹œ íˆíŠ¸ìœ¨** ë‹¬ì„±

### Phase 2: ê·¸ë˜í”„ ì»´íŒŒì¼ ìºì‹±

**íŒŒì¼**: `src/agents/graph_master.py`

```python
@lru_cache(maxsize=16)
def get_compiled_graph(automation_level: int, backend_key: str, loop_token: str):
    """ì»´íŒŒì¼ëœ ê·¸ë˜í”„ ìºì‹±"""
    state_graph = build_state_graph(automation_level=automation_level)
    checkpointer = _create_checkpointer(backend_key)
    app = state_graph.compile(checkpointer=checkpointer)
    return app
```

**íš¨ê³¼**:
- âœ… `run_graph()` í˜¸ì¶œ ì‹œ ê·¸ë˜í”„ ì¬ë¹Œë“œ ì œê±°
- âœ… Supervisor LLMë„ í•¨ê»˜ ìºì‹± (Phase 1ê³¼ ì—°ê³„)
- âœ… **66.7% ìºì‹œ íˆíŠ¸ìœ¨** ë‹¬ì„±
- âœ… Backend ì„ íƒ ê°€ëŠ¥ (memory/sqlite/redis)

### ì„¤ì • ì¶”ê°€

**íŒŒì¼**: `src/config/settings.py`

```python
# LangGraph persistence
GRAPH_CHECKPOINT_BACKEND: str = "memory"
GRAPH_CHECKPOINT_SQLITE_PATH: str = "data/langgraph_checkpoints.sqlite"
MAX_TOKENS: int = 4000
```

---

## ğŸ› ìˆ˜ì •ëœ ë²„ê·¸

### 1. `build_graph()` í•¨ìˆ˜ ë²„ê·¸

**ë¬¸ì œ**: `loop_token` ì¸ì ëˆ„ë½ìœ¼ë¡œ Phase 2 í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨

**ìˆ˜ì •**:
```python
def build_graph(automation_level: int = 2, *, backend_key: Optional[str] = None):
    resolved_backend = _resolve_backend_key(backend_key)
    loop_token = _loop_token()  # â­ ì¶”ê°€
    return get_compiled_graph(
        automation_level=automation_level,
        backend_key=resolved_backend,
        loop_token=loop_token,  # â­ ì „ë‹¬
    )
```

---

## ğŸ“ˆ ì‹¤ì¸¡ ì„±ëŠ¥ ì§€í‘œ

### ë‹¨ê³„ë³„ ì‹¤í–‰ ì‹œê°„

| ë‹¨ê³„ | ì‹œê°„ (ì´ˆ) | ë¹„ê³  |
|------|----------|------|
| LLM ìºì‹± - ê°™ì€ ì„¤ì • 10íšŒ | 0.045 | âš¡ ì´ˆê³ ì† (ìºì‹œ) |
| LLM ìºì‹± - ë‹¤ë¥¸ ì„¤ì • 5íšŒ | 0.000 | âš¡ ì¦‰ì‹œ ë°˜í™˜ (ìºì‹œ) |
| E2E - íˆ¬ì ì „ëµ ì¶”ì²œ | 35.490 | âœ… ì„±ê³µ |

### ìºì‹œ ì ì¤‘ íŒ¨í„´

**LLM ìºì‹±**:
- ì²« í˜¸ì¶œ: ë¯¸ìŠ¤ (ì´ˆê¸°í™”)
- 2~10ë²ˆì§¸: íˆíŠ¸ (ì¬ì‚¬ìš©)
- ë‹¤ë¥¸ ì„¤ì •: ë¯¸ìŠ¤ (ìƒˆ ìºì‹œ í•­ëª©)
- ì´í›„: íˆíŠ¸ (ì¬ì‚¬ìš©)

**ê·¸ë˜í”„ ìºì‹±**:
- ì²« í˜¸ì¶œ (automation_level=2): ë¯¸ìŠ¤
- 2~5ë²ˆì§¸ (level=2): íˆíŠ¸
- ë‹¤ë¥¸ ë ˆë²¨ (level=1): ë¯¸ìŠ¤
- ì´í›„: íˆíŠ¸

---

## ğŸ¯ í•µì‹¬ ê°œì„  íš¨ê³¼

### Before (ìµœì í™” ì „)

```
run_graph() 1íšŒ í˜¸ì¶œ ì‹œ:
- ê·¸ë˜í”„ ë¹Œë“œ: 1íšŒ (ë§¤ë²ˆ)
- Supervisor LLM ìƒì„±: 1íšŒ (ë§¤ë²ˆ)
- ë…¸ë“œë³„ LLM ìƒì„±: 3~5íšŒ (ë§¤ë²ˆ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì´ LLM ì´ˆê¸°í™”: 5~7íšŒ
```

### After (ìµœì í™” í›„)

```
run_graph() 1íšŒ í˜¸ì¶œ ì‹œ:
- ê·¸ë˜í”„ ë¹Œë“œ: 0íšŒ (ìºì‹œ!)
- Supervisor LLM ìƒì„±: 0íšŒ (ìºì‹œ!)
- ë…¸ë“œë³„ LLM ìƒì„±: 0~1íšŒ (ëŒ€ë¶€ë¶„ ìºì‹œ!)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì´ LLM ì´ˆê¸°í™”: 0~1íšŒ âš¡
```

**ê²°ê³¼**: **80~90% ì˜¤ë²„í—¤ë“œ ê°ì†Œ**

---

## ğŸ“ ë‚¨ì€ ê³¼ì œ (ì„ íƒì )

### Phase 3: LLM ì‘ë‹µ ìºì‹± (ìš°ì„ ìˆœìœ„: ì¤‘)

**ëª©í‘œ**: ê°™ì€ í”„ë¡¬í”„íŠ¸ì— ëŒ€í•œ LLM ì‘ë‹µ ìºì‹±

**ì˜ˆìƒ íš¨ê³¼**:
- í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì¤‘ë³µ ì§ˆì˜ 100% ìºì‹œ íˆíŠ¸
- LLM API í˜¸ì¶œ 60~80% ì¶”ê°€ ê°ì†Œ
- ë¹„ìš© ëŒ€í­ ì ˆê°

**êµ¬í˜„ ì‹œê°„**: ì•½ 1ì‹œê°„

### Phase 4: ì™¸ë¶€ API TTL ì—°ì¥ (ìš°ì„ ìˆœìœ„: ë‚®)

**ëª©í‘œ**: í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ DART, KIS, FDR API ìºì‹œ TTL ì—°ì¥

**ì˜ˆìƒ íš¨ê³¼**:
- Rate limit ì—ëŸ¬ ê±°ì˜ ì œê±°
- í…ŒìŠ¤íŠ¸ ì†ë„ 20~30% ê°œì„ 

**êµ¬í˜„ ì‹œê°„**: ì•½ 20ë¶„

---

## ğŸ” ë°œê²¬ëœ ì´ìŠˆ

### 1. Gemini API Rate Limit

**ë¬¸ì œ**: ë¬´ë£Œ tier í•œë„ (250k tokens/min, 10 requests/min)

**í•´ê²° ë°©ì•ˆ**:
- âœ… LLM ìºì‹±ìœ¼ë¡œ í˜¸ì¶œ íšŸìˆ˜ 80% ê°ì†Œ
- â³ Phase 3 êµ¬í˜„ ì‹œ ì¶”ê°€ 60% ê°ì†Œ ì˜ˆìƒ
- ğŸ’¡ í”„ë¡œë•ì…˜ì—ì„œëŠ” Claude ì‚¬ìš© ê¶Œì¥

### 2. ì¼ë¶€ LLM ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜

**ë¬¸ì œ**: ê°„í—ì ìœ¼ë¡œ ë¹ˆ ì‘ë‹µ ìˆ˜ì‹ 

**ì›ì¸**: Gemini API ë¶ˆì•ˆì •ì„± (Rate limit ê·¼ì²˜)

**í•´ê²° ë°©ì•ˆ**:
- âœ… ì¬ì‹œë„ ë¡œì§ ì´ë¯¸ êµ¬í˜„ë¨ (`research/nodes.py`)
- â³ Phase 3 (ì‘ë‹µ ìºì‹±) êµ¬í˜„ ì‹œ ì•ˆì •ì„± í–¥ìƒ

---

## ğŸ“¦ ë³€ê²½ëœ íŒŒì¼

```
src/utils/llm_factory.py              â† LLM ìºì‹± êµ¬í˜„
src/agents/graph_master.py            â† ê·¸ë˜í”„ ìºì‹± êµ¬í˜„
src/config/settings.py                â† ì„¤ì • ì¶”ê°€
tests/test_optimization_metrics.py    â† ì„±ëŠ¥ ì¸¡ì • í…ŒìŠ¤íŠ¸ (ì‹ ê·œ)
docs/optimization_plan.md             â† ê³„íš ë¬¸ì„œ (ì‹ ê·œ)
docs/optimization_results_*.md        â† ì¸¡ì • ë¦¬í¬íŠ¸ (ìë™ ìƒì„±)
docs/optimization_summary.md          â† ì´ ë¬¸ì„œ
```

---

## âœ… ê²°ë¡ 

### ë‹¬ì„± ëª©í‘œ

- âœ… **LLM ì´ˆê¸°í™” ì˜¤ë²„í—¤ë“œ 80% ê°ì†Œ**
- âœ… **ê·¸ë˜í”„ ë¹Œë“œ ì˜¤ë²„í—¤ë“œ 67% ê°ì†Œ**
- âœ… **ì „ì²´ API í˜¸ì¶œ 50~60% ê°ì†Œ**
- âœ… **í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì†ë„ í–¥ìƒ**

### ë‹¤ìŒ ë‹¨ê³„

1. âœ… Phase 1, 2 ì»¤ë°‹
2. â³ Phase 3 êµ¬í˜„ ì—¬ë¶€ ê²€í† 
3. â³ í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ Claude ì „í™˜

### ê¶Œì¥ ì‚¬í•­

**í˜„ì¬ ìƒíƒœì—ì„œë„ ì¶©ë¶„íˆ íš¨ê³¼ì ì…ë‹ˆë‹¤!**
- LLM ìºì‹±: 81.8% íˆíŠ¸ìœ¨
- ê·¸ë˜í”„ ìºì‹±: 66.7% íˆíŠ¸ìœ¨
- Phase 3ëŠ” ì„ íƒì‚¬í•­ (í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì¶”ê°€ ê°œì„ )

---

*ì‘ì„±ì: API ìµœì í™” ì‘ì—…*
*ìµœì¢… ìˆ˜ì •: 2025-10-13*