# 에이전트 아키텍쳐

종류: 아키텍쳐
버전: 1.0
생성일: 2025년 9월 30일 오후 7:09
최종 편집일시: 2025년 10월 1일 오전 12:02
담당자: 지우 최

## 문서 정보

| 항목 | 내용 |
| --- | --- |
| 문서명 | 에이전트 아키텍처 명세서 |
| 버전 | v2.0 |
| 작성일 | 2025-09-30 |
| 관련 문서 | PRD v2.0 |
| 상태 | 설계 완료 |

---

## 목차

1. [시스템 개요](https://www.notion.so/27e630957afa80aba3cbcf303082c8e6?pvs=21)
2. [아키텍처 설계 원칙](https://www.notion.so/27e630957afa80aba3cbcf303082c8e6?pvs=21)
3. [전체 아키텍처](https://www.notion.so/27e630957afa80aba3cbcf303082c8e6?pvs=21)
4. [에이전트 상세 명세](https://www.notion.so/27e630957afa80aba3cbcf303082c8e6?pvs=21)
5. [에이전트 간 상호작용](https://www.notion.so/27e630957afa80aba3cbcf303082c8e6?pvs=21)
6. [Phase별 구현 계획](https://www.notion.so/27e630957afa80aba3cbcf303082c8e6?pvs=21)
7. [기술 스택](https://www.notion.so/27e630957afa80aba3cbcf303082c8e6?pvs=21)

---

## 1. 시스템 개요

### 1.1 목적

개인 투자자를 위한 Human-in-the-Loop 기반 멀티 에이전트 AI 투자 시스템의 에이전트 구조를 정의한다.

### 1.2 핵심 설계 철학

- **책임의 명확한 분리**: 각 에이전트는 단일 책임 원칙(SRP) 준수
- **느슨한 결합**: 에이전트 간 독립성 보장
- **확장 가능성**: 새로운 에이전트 추가 용이
- **HITL 최적화**: 사용자 개입 시점의 명확한 정의

### 1.3 에이전트 개수 및 계층

| 계층 | 에이전트 수 | Phase 1 | Phase 2 | Phase 3 |
| --- | --- | --- | --- | --- |
| **레벨 0 (조율)** | 1개 | 1 | 1 | 1 |
| **레벨 1 (핵심)** | 6개 | 5 | 6 | 6 |
| **레벨 2 (지원)** | 5개 | 3 | 5 | 6 |
| **총계** | **12개** | **9개** | **12개** | **13개** |

---

## 2. 아키텍처 설계 원칙

### 2.1 Single Responsibility Principle (단일 책임 원칙)

각 에이전트는 하나의 명확한 역할만 수행한다.

**예시:**

- ✅ **전략 에이전트**: 종목 발굴 및 시그널 생성
- ✅ **포트폴리오 에이전트**: 자산 배분 최적화
- ❌ 전략 에이전트가 포트폴리오 최적화까지 담당 (X)

### 2.2 Interface Segregation (인터페이스 분리)

에이전트 간 통신은 명확한 인터페이스를 통해서만 이루어진다.

```python
# 에이전트 간 표준 인터페이스
class AgentInterface:
    async def process(self, input: AgentInput) -> AgentOutput:
        """에이전트 처리 로직"""
        pass

    async def validate(self, input: AgentInput) -> bool:
        """입력 검증"""
        pass

```

### 2.3 Separation of Concerns (관심사의 분리)

- **데이터 수집** ≠ **데이터 분석**
- **전략 생성** ≠ **포트폴리오 최적화**
- **심층 분석** ≠ **실시간 모니터링**

### 2.4 HITL Integration Points

각 에이전트는 HITL 개입이 필요한 시점을 명확히 정의한다.

```python
@dataclass
class HITLTrigger:
    agent: str
    action: str
    reason: str
    urgency: Literal["low", "medium", "high"]
    automation_level: int  # 1-3

```

---

## 3. 전체 아키텍처

### 3.1 3계층 구조

```
┌─────────────────────────────────────────────────────┐
│              레벨 0: 조율 계층                        │
│                                                     │
│            ┌───────────────────────┐                │
│            │   마스터 에이전트      │                │
│            │   (Orchestrator)      │                │
│            └───────────┬───────────┘                │
└────────────────────────┼───────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│              레벨 1: 핵심 기능 계층                   │
│                                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │ 개인화   │  │데이터수집 │  │  리서치  │          │
│  │ 에이전트 │  │ 에이전트 │  │ 에이전트 │          │
│  └──────────┘  └──────────┘  └──────────┘          │
│                                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  전략    │  │포트폴리오 │  │  실행    │          │
│  │ 에이전트 │  │ 에이전트 │  │ 에이전트 │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└─────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────┐
│              레벨 2: 지원 기능 계층                   │
│                                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │  리스크  │  │ 모니터링 │  │백테스팅  │          │
│  │ 에이전트 │  │ 에이전트 │  │ 에이전트 │          │
│  └──────────┘  └──────────┘  └──────────┘          │
│                                                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐          │
│  │컴플라이언스│ │ 교육/질의│  │ 감정분석 │          │
│  │ 에이전트 │  │ 에이전트 │  │ 에이전트 │          │
│  └──────────┘  └──────────┘  └──────────┘          │
└─────────────────────────────────────────────────────┘

```

### 3.2 정보 흐름

```
사용자 입력 (Chat)
    ↓
마스터 에이전트 (의도 분석 + 라우팅)
    ↓
┌───────────────────────────────────┐
│  병렬 처리: 필요한 에이전트들 호출        │
│  • 개인화 → 사용자 컨텍스트 로드         │
│  • 데이터수집 → 최신 데이터 수집         │
│  • 리서치 → 심층 분석                 │
│  • 전략 → 시그널 생성                 │
│  • 리스크 → 위험도 평가               │
└───────────────────────────────────┘
    ↓
마스터 에이전트 (결과 통합)
    ↓
HITL 개입 필요 여부 판단
    ↓
┌─ YES → 사용자 승인 요청
│  ↓
│  사용자 응답
│  ↓
└─ NO → 자동 처리
    ↓
실행 에이전트 (필요 시)
    ↓
결과 반환 및 저장

```

---

## 4. 에이전트 상세 명세

### 레벨 0: 조율 계층

---

### 🎯 마스터 에이전트 (Orchestrator Agent)

**ID**: `master_agent`

**Phase**: Phase 1 (MVP)

**Priority**: P0 (필수)

**역할**

- 전체 시스템 조율 및 의도 분석
- 사용자 질의를 적절한 에이전트(들)에게 라우팅
- 여러 에이전트의 결과 통합
- HITL 개입 시점 판단 및 트리거

**핵심 기능**

1. **의도 분석 (Intent Classification)**
    
    ```python
    categories = [
        "stock_analysis",      # 종목 분석
        "trade_execution",     # 매매 실행
        "portfolio_review",    # 포트폴리오 평가
        "rebalancing",         # 리밸런싱
        "market_status",       # 시장 상황
        "general_question"     # 일반 질문
    ]
    
    ```
    
2. **라우팅 로직**
    
    ```python
    routing_map = {
        "stock_analysis": [
            "data_collection",
            "research",
            "strategy"
        ],
        "trade_execution": [
            "strategy",
            "risk",
            "execution"
        ],
        # ...
    }
    
    ```
    
3. **결과 통합**
    - 여러 에이전트의 출력을 하나의 응답으로 합성
    - 충돌하는 의견 조정 (Bull vs Bear)
4. **HITL 트리거 판단**
    
    ```python
    def should_trigger_hitl(
        action: str,
        confidence: float,
        risk_level: str,
        user_automation_level: int
    ) -> bool:
        # 자동화 레벨별 트리거 로직
        pass
    
    ```
    

**입력**

- 사용자 질의 (자연어)
- 사용자 프로필 (개인화 에이전트로부터)
- 자동화 레벨 설정

**출력**

- 통합된 응답
- HITL 트리거 (필요 시)
- 실행 명령 (하위 에이전트에게)

**서브 에이전트**: 없음

**HITL 개입**: 직접 트리거 발동

**구현 복잡도**: ⭐⭐⭐ (Medium-High)

---

### 레벨 1: 핵심 기능 계층

---

### 👤 개인화 에이전트 (Personalization Agent)

**ID**: `personalization_agent`

**Phase**: Phase 1 (기본), Phase 2 (고도화)

**Priority**: P1 (Phase 1), P0 (Phase 2)

**역할**

- 사용자 프로필 관리 및 업데이트
- 투자 성향 추적 및 학습
- 자동화 레벨 최적화 제안
- 다른 에이전트에게 사용자 컨텍스트 제공

**핵심 기능**

1. **프로필 관리**
    
    ```python
    @dataclass
    class UserProfile:
        user_id: str
        risk_tolerance: str  # 공격적/적극적/중립/보수적/안전
        investment_goal: str  # 단기수익/중장기성장/배당/기타
        investment_horizon: str  # 1년미만/1-3년/3-5년/5년이상
        automation_level: int  # 1-3
        preferred_sectors: List[str]
        avoided_stocks: List[str]
        created_at: datetime
        updated_at: datetime
    
    ```
    
2. **행동 패턴 분석** (Phase 2)
    
    ```python
    class BehaviorAnalyzer:
        def analyze_decision_pattern(
            self,
            user_id: str
        ) -> Dict:
            """사용자의 과거 의사결정 패턴 분석"""
            return {
                "ai_acceptance_rate": 0.75,
                "common_rejection_reasons": [...],
                "preferred_intervention_level": "medium"
            }
    
    ```
    
3. **선호도 학습** (Phase 2)
    - 사용자가 자주 조회하는 종목/섹터
    - 거부한 추천의 공통점
    - 수용한 추천의 공통점
4. **자동화 레벨 최적화**
    
    ```python
    def suggest_automation_level(
        self,
        user_id: str
    ) -> Dict:
        """사용자 경험 기반 최적 자동화 레벨 제안"""
        pass
    
    ```
    

**입력**

- 사용자 ID
- 초기 설문 데이터
- 과거 의사결정 이력 (Phase 2)

**출력**

- 사용자 프로필
- 선호도 정보
- 자동화 레벨 추천

**서브 에이전트**

- 프로필 관리 서브에이전트
- 행동 패턴 분석 서브에이전트 (Phase 2)
- 선호도 학습 서브에이전트 (Phase 2)

**HITL 개입**: 프로필 수정 시

**구현 복잡도**: ⭐⭐ (Low-Medium) - Phase 1 기본 버전

---

### 📥 데이터 수집 에이전트 (Data Collection Agent)

**ID**: `data_collection_agent`

**Phase**: Phase 1 (MVP)

**Priority**: P0 (필수)

**역할**

- 멀티소스 데이터 수집 조율
- 데이터 품질 관리
- 캐싱 및 업데이트 전략
- API 레이트 리밋 관리

**핵심 기능**

1. **데이터 소스 관리**
    
    ```python
    data_sources = {
        "dart": DARTAPIClient(),
        "kis": KoreaInvestmentAPIClient(),
        "news": NewsScraperClient()
    }
    
    ```
    
2. **데이터 수집 조율**
    
    ```python
    async def collect_data(
        self,
        ticker: str,
        data_types: List[str]
    ) -> Dict:
        tasks = []
        if "financials" in data_types:
            tasks.append(self.dart.get_financials(ticker))
        if "price" in data_types:
            tasks.append(self.kis.get_price(ticker))
        # 병렬 수집
        results = await asyncio.gather(*tasks)
        return self.merge_results(results)
    
    ```
    
3. **캐싱 전략**
    
    ```python
    cache_config = {
        "financials": timedelta(days=1),
        "price": timedelta(minutes=5),
        "news": timedelta(hours=1)
    }
    
    ```
    
4. **데이터 정규화**
    - 각 소스의 데이터를 표준 포맷으로 변환
5. **API 레이트 리밋 관리**
    
    ```python
    rate_limiter = {
        "dart": RateLimiter(calls=100, period=60),
        "kis": RateLimiter(calls=1000, period=60)
    }
    
    ```
    

**입력**

- 데이터 요청 (종목코드, 데이터 타입)
- 캐시 여부

**출력**

- 정규화된 데이터
- 데이터 메타정보 (수집 시간, 소스 등)

**서브 에이전트**: 없음 (클라이언트 모듈 사용)

**HITL 개입**: 없음 (완전 자동화)

**구현 복잡도**: ⭐⭐ (Medium)

---

### 🔍 리서치 에이전트 (Research Agent)

**ID**: `research_agent`

**Phase**: Phase 1 (MVP)

**Priority**: P0 (필수)

**역할**

- 기업 재무제표 심층 분석
- 산업/섹터 분석
- 기술적 지표 계산 및 해석
- 경쟁사 비교 분석

**핵심 기능**

1. **재무제표 분석**
    
    ```python
    def analyze_financials(
        self,
        ticker: str
    ) -> FinancialAnalysis:
        return {
            "profitability": {
                "roe": 0.15,
                "roa": 0.08,
                "net_margin": 0.12
            },
            "growth": {
                "revenue_growth": 0.10,
                "profit_growth": 0.15
            },
            "stability": {
                "debt_ratio": 0.35,
                "current_ratio": 1.8
            },
            "valuation": {
                "per": 15.5,
                "pbr": 1.2,
                "psr": 0.8
            }
        }
    
    ```
    
2. **산업 분석**
    
    ```python
    def analyze_industry(
        self,
        sector: str
    ) -> IndustryAnalysis:
        """섹터별 트렌드, 성장성, 경쟁 구도 분석"""
        pass
    
    ```
    
3. **기술적 지표**
    
    ```python
    technical_indicators = [
        "moving_average",  # 이동평균
        "rsi",            # 상대강도지수
        "macd",           # MACD
        "bollinger_bands" # 볼린저밴드
    ]
    
    ```
    
4. **경쟁사 비교**
    
    ```python
    def compare_competitors(
        self,
        ticker: str,
        competitors: List[str]
    ) -> ComparisonReport:
        """동종업계 기업들과의 비교 분석"""
        pass
    
    ```
    

**입력**

- 종목 코드
- 분석 타입 (재무/산업/기술적/비교)
- 데이터 (데이터 수집 에이전트로부터)

**출력**

- 분석 리포트
- 평가 점수 (1-5)
- 주요 인사이트

**서브 에이전트**

- 기업 분석 서브에이전트
- 산업 분석 서브에이전트
- 기술적 분석 서브에이전트

**HITL 개입**: 없음 (정보 제공만)

**구현 복잡도**: ⭐⭐⭐ (High)

---

### 💡 전략 에이전트 (Strategy Agent)

**ID**: `strategy_agent`

**Phase**: Phase 1 (MVP)

**Priority**: P0 (필수)

**역할**

- 종목 발굴 및 스크리닝
- 매수/매도 시그널 생성
- Bull/Bear 시나리오 분석
- 투자 테마 발굴

**핵심 기능**

1. **종목 스크리닝**
    
    ```python
    def screen_stocks(
        self,
        criteria: Dict
    ) -> List[str]:
        """조건에 맞는 종목 필터링"""
        return filtered_tickers
    
    ```
    
2. **매매 시그널 생성**
    
    ```python
    @dataclass
    class TradingSignal:
        ticker: str
        action: Literal["BUY", "SELL", "HOLD"]
        confidence: float  # 0-1
        price_target: float
        reasoning: str
        bull_case: str
        bear_case: str
    
    ```
    
3. **Bull/Bear 시나리오**
    
    ```python
    class ScenarioAnalyzer:
        def analyze(self, ticker: str) -> Dict:
            bull = self.bull_agent.analyze(ticker)
            bear = self.bear_agent.analyze(ticker)
    
            return {
                "bull": {
                    "confidence": bull.confidence,
                    "reasoning": bull.reasoning
                },
                "bear": {
                    "confidence": bear.confidence,
                    "reasoning": bear.reasoning
                },
                "consensus": self.calculate_consensus(bull, bear)
            }
    
    ```
    
4. **투자 테마 발굴**
    - 산업 트렌드 기반 테마 발굴
    - 정책/이벤트 기반 테마

**입력**

- 분석 데이터 (리서치 에이전트로부터)
- 사용자 프로필 (개인화 에이전트로부터)
- 시장 상황

**출력**

- 매매 시그널
- 추천 종목 리스트
- Bull/Bear 분석 결과

**서브 에이전트**

- Bull 애널리스트 서브에이전트
- Bear 애널리스트 서브에이전트
- 종목 스크리너 서브에이전트

**HITL 개입**:

- 신규 전략 제안 시 (레벨 2, 3)
- 기존 전략 변경 시 (모든 레벨)
- Bull/Bear 의견 차이 < 10%p 시

**구현 복잡도**: ⭐⭐⭐⭐ (High)

---

### 📊 포트폴리오 에이전트 (Portfolio Agent)

**ID**: `portfolio_agent`

**Phase**: Phase 1 (MVP)

**Priority**: P0 (필수)

**역할**

- 자산 배분 최적화
- 포트폴리오 구성안 생성
- 리밸런싱 제안
- 성과 추적 및 리포팅

**핵심 기능**

1. **자산 배분 최적화**
    
    ```python
    def optimize_allocation(
        self,
        candidates: List[str],
        total_capital: float,
        constraints: Dict
    ) -> Dict[str, float]:
        """
        최적 포트폴리오 구성
        - 샤프 비율 최대화
        - 리스크 제약 준수
        - 섹터 분산
        """
        pass
    
    ```
    
2. **포트폴리오 구성**
    
    ```python
    @dataclass
    class Portfolio:
        positions: Dict[str, Position]
        total_value: float
        cash: float
        expected_return: float
        risk: float
        sharpe_ratio: float
    
    ```
    
3. **리밸런싱 제안**
    
    ```python
    def generate_rebalancing_plan(
        self,
        current_portfolio: Portfolio,
        target_allocation: Dict[str, float]
    ) -> RebalancingPlan:
        """현재 vs 목표 비교 후 거래 계획 생성"""
        pass
    
    ```
    
4. **성과 추적**
    
    ```python
    def calculate_performance(
        self,
        portfolio: Portfolio,
        benchmark: str = "KOSPI"
    ) -> PerformanceReport:
        return {
            "total_return": 0.052,
            "benchmark_return": 0.038,
            "alpha": 0.014,
            "sharpe": 1.25,
            "max_drawdown": -0.15
        }
    
    ```
    

**입력**

- 종목 추천 (전략 에이전트로부터)
- 사용자 프로필 (개인화 에이전트로부터)
- 현재 포트폴리오 (있는 경우)
- 제약 조건 (리스크 에이전트로부터)

**출력**

- 포트폴리오 구성안
- 리밸런싱 계획
- 성과 리포트

**서브 에이전트**

- 자산배분 최적화 서브에이전트
- 성과분석 서브에이전트

**HITL 개입**:

- 포트폴리오 구성 시 (자동화 레벨별)
- 리밸런싱 제안 시 (자동화 레벨별)

**구현 복잡도**: ⭐⭐⭐⭐ (High)

---

### ⚡ 실행 에이전트 (Execution Agent)

**ID**: `execution_agent`

**Phase**: Phase 2

**Priority**: P0 (Phase 2에서 필수)

**역할**

- 주문 생성 및 검증
- 증권사 API 호출
- 체결 모니터링
- 주문 관리 (취소/수정)

**핵심 기능**

1. **주문 생성**
    
    ```python
    @dataclass
    class Order:
        order_id: str
        ticker: str
        action: Literal["BUY", "SELL"]
        quantity: int
        price_type: Literal["MARKET", "LIMIT"]
        limit_price: Optional[float]
        status: str
    
    ```
    
2. **주문 검증**
    
    ```python
    def validate_order(
        self,
        order: Order,
        portfolio: Portfolio
    ) -> ValidationResult:
        """
        검증 항목:
        - 잔고 충분 여부
        - 거래 한도 초과 여부
        - 시장 시간 확인
        - 호가 단위 검증
        """
        pass
    
    ```
    
3. **주문 분할** (대량 거래)
    
    ```python
    def split_order(
        self,
        order: Order,
        max_size: int
    ) -> List[Order]:
        """대량 주문을 여러 개로 분할"""
        pass
    
    ```
    
4. **체결 모니터링**
    
    ```python
    async def monitor_execution(
        self,
        order_id: str
    ) -> ExecutionStatus:
        """주문 체결 상태 실시간 추적"""
        pass
    
    ```
    
5. **슬리피지 관리**
    
    ```python
    def calculate_slippage(
        self,
        expected_price: float,
        actual_price: float
    ) -> float:
        """예상가 대비 실제 체결가 차이"""
        return (actual_price - expected_price) / expected_price
    ```
    

**입력**

- 매매 계획 (포트폴리오 에이전트로부터)
- 사용자 승인 (HITL)
- 계좌 정보

**출력**

- 주문 ID
- 체결 결과
- 거래 내역

**서브 에이전트**

- 주문 검증 서브에이전트
- 체결 모니터링 서브에이전트

**HITL 개입**:

- 주문 실행 전 최종 승인 (자동화 레벨별)

**구현 복잡도**: ⭐⭐⭐⭐ (High)

---

### 레벨 2: 지원 기능 계층

---

### 🛡️ 리스크 에이전트 (Risk Agent)

**ID**: `risk_agent`

**Phase**: Phase 1 (MVP)

**Priority**: P0 (필수)

**역할**

- 포트폴리오 리스크 측정
- 집중도 리스크 평가
- 손실 가능성 시뮬레이션
- HITL 트리거 발동

**핵심 기능**

1. **리스크 측정**
    
    ```python
    def measure_risk(
        self,
        portfolio: Portfolio
    ) -> RiskMetrics:
        return {
            "volatility": 0.163,  # 변동성
            "var_95": -0.08,      # 95% VaR
            "max_drawdown": -0.15,
            "concentration_risk": "medium",
            "sector_exposure": {...}
        }
    
    ```
    
2. **집중도 리스크**
    
    ```python
    def check_concentration(
        self,
        portfolio: Portfolio,
        threshold: float = 0.2
    ) -> List[Alert]:
        """단일 종목/섹터 비중 초과 검사"""
        alerts = []
        for ticker, weight in portfolio.weights.items():
            if weight > threshold:
                alerts.append(Alert(
                    level="warning",
                    message=f"{ticker} 비중 {weight:.1%} 초과"
                ))
        return alerts
    
    ```
    
3. **손실 시뮬레이션**
    
    ```python
    def simulate_loss(
        self,
        portfolio: Portfolio,
        scenarios: List[str]
    ) -> Dict:
        """다양한 시나리오에서의 손실 가능성"""
        return {
            "market_crash": -0.32,
            "sector_decline": -0.18,
            "normal_volatility": -0.08
        }
    
    ```
    
4. **HITL 트리거**
    
    ```python
    def should_trigger_hitl(
        self,
        action: str,
        risk_metrics: RiskMetrics
    ) -> bool:
        """리스크 임계값 초과 시 HITL 발동"""
        pass
    
    ```
    

**입력**

- 포트폴리오 정보
- 매매 계획
- 사용자 리스크 허용도

**출력**

- 리스크 지표
- 경고 메시지
- HITL 트리거 (필요 시)

**서브 에이전트**: 없음

**HITL 개입**:

- 리스크 임계값 초과 시 자동 트리거

**구현 복잡도**: ⭐⭐⭐ (Medium-High)

---

### 📡 모니터링 에이전트 (Monitoring Agent)

**ID**: `monitoring_agent`

**Phase**: Phase 1 (기본), Phase 2 (고도화)

**Priority**: P0 (Phase 1), P1 (Phase 2)

**역할**

- 실시간 시장/포트폴리오 감시
- 이벤트 감지 및 알림
- 이상 징후 탐지

**핵심 기능**

1. **가격 모니터링**
    
    ```python
    async def monitor_prices(
        self,
        tickers: List[str],
        interval: int = 60
    ):
        """실시간 가격 변동 추적"""
        while True:
            for ticker in tickers:
                price_change = await self.get_price_change(ticker)
                if abs(price_change) > self.threshold:
                    await self.send_alert(ticker, price_change)
            await asyncio.sleep(interval)
    
    ```
    
2. **이벤트 감지**
    
    ```python
    event_types = [
        "disclosure",     # 공시
        "news",          # 뉴스
        "price_spike",   # 급등/급락
        "volume_surge"   # 거래량 급증
    ]
    
    ```
    
3. **트리거 기반 알림**
    
    ```python
    @dataclass
    class AlertTrigger:
        type: str
        condition: str
        threshold: float
        action: str  # "notify", "stop_trading", etc.
    
    ```
    
4. **이상 징후 탐지** (Phase 2)
    
    ```python
    def detect_anomaly(
        self,
        time_series: pd.Series
    ) -> bool:
        """통계적 이상치 탐지"""
        pass
    
    ```
    

**입력**

- 모니터링 대상 (보유 종목 등)
- 트리거 설정 (사용자 설정)
- 실시간 데이터

**출력**

- 알림 메시지
- 이벤트 로그

**서브 에이전트**: 없음

**HITL 개입**:

- 중요 이벤트 발생 시 알림

**구현 복잡도**: ⭐⭐⭐ (Medium-High)

---

### 🧪 백테스팅 에이전트 (Backtesting Agent)

**ID**: `backtesting_agent`

**Phase**: Phase 2

**Priority**: P1

**역할**

- 과거 데이터 기반 전략 시뮬레이션
- 성과 지표 계산
- What-if 시나리오 분석

**핵심 기능**

1. **전략 시뮬레이션**
    
    ```python
    def backtest(
        self,
        strategy: Strategy,
        start_date: date,
        end_date: date,
        initial_capital: float = 10_000_000
    ) -> BacktestResult:
        """과거 데이터로 전략 검증"""
        pass
    
    ```
    
2. **성과 지표**
    
    ```python
    @dataclass
    class BacktestResult:
        total_return: float
        annual_return: float
        sharpe_ratio: float
        max_drawdown: float
        win_rate: float
        profit_factor: float
        trades: List[Trade]
    
    ```
    
3. **시나리오 분석**
    
    ```python
    def what_if_analysis(
        self,
        portfolio: Portfolio,
        scenario: str
    ) -> Dict:
        """만약 ~했다면? 분석"""
        pass
    
    ```
    

**입력**

- 전략 정의
- 기간
- 초기 자본
- 과거 데이터

**출력**

- 백테스팅 결과
- 성과 지표
- 거래 내역

**서브 에이전트**: 없음

**HITL 개입**: 없음 (정보 제공만)

**구현 복잡도**: ⭐⭐⭐⭐ (High)

---

### ⚖️ 컴플라이언스 에이전트 (Compliance Agent)

**ID**: `compliance_agent`

**Phase**: Phase 2

**Priority**: P1

**역할**

- 법적 규제 준수 확인
- 거래 적법성 체크
- 감사 로그 생성

**핵심 기능**

1. **거래 적법성 체크**
    
    ```python
    def check_compliance(
        self,
        order: Order,
        user_info: Dict
    ) -> ComplianceCheck:
        """
        검사 항목:
        - 내부자 거래 금지 기간
        - 시세 조종 패턴
        - 일일 거래 한도
        - 레버리지 한도
        """
        pass
    
    ```
    
2. **감사 로그**
    
    ```python
    def log_transaction(
        self,
        transaction: Transaction
    ):
        """모든 거래 기록 저장"""
        self.audit_log.append({
            "timestamp": datetime.now(),
            "user_id": transaction.user_id,
            "action": transaction.action,
            "details": transaction.details
        })
    
    ```
    
3. **규제 업데이트 추적**
    
    ```python
    def check_regulation_updates(self):
        """금융 규제 변경사항 추적"""
        pass
    
    ```
    

**입력**

- 주문 정보
- 사용자 정보
- 규제 DB

**출력**

- 적법성 판단 (Pass/Fail)
- 위반 사유 (있는 경우)
- 감사 로그

**서브 에이전트**: 없음

**HITL 개입**:

- 규제 위반 가능성 있을 때 경고

**구현 복잡도**: ⭐⭐⭐ (Medium-High)

---

### 📚 교육/질의 에이전트 (Education/Q&A Agent)

**ID**: `education_agent`

**Phase**: Phase 1 (MVP)

**Priority**: P1

**역할**

- 일반 투자 지식 제공
- 투자 용어 설명
- 시장 상황 해설

**핵심 기능**

1. **용어 설명**
    
    ```python
    def explain_term(self, term: str) -> str:
        """금융 용어 쉽게 설명"""
        pass
    
    ```
    
2. **시장 해설**
    
    ```python
    def explain_market_situation(
        self,
        topic: str
    ) -> str:
        """현재 시장 상황을 쉽게 해석"""
        pass
    
    ```
    
3. **투자 교육**
    
    ```python
    education_topics = [
        "투자 기초",
        "포트폴리오 이론",
        "리스크 관리",
        "재무제표 읽는 법"
    ]
    
    ```
    

**입력**

- 사용자 질문
- 사용자 레벨 (초보/중급/고급)

**출력**

- 설명 텍스트
- 참고 자료 링크

**서브 에이전트**: 없음

**HITL 개입**: 없음

**구현 복잡도**: ⭐⭐ (Low-Medium)

---

### 💭 감정 분석 에이전트 (Sentiment Analysis Agent)

**ID**: `sentiment_agent`

**Phase**: Phase 3 (선택)

**Priority**: P2

**역할**

- 뉴스 센티먼트 분석
- 소셜미디어 트렌드
- 시장 심리 지표

**핵심 기능**

1. **뉴스 센티먼트**
    
    ```python
    def analyze_news_sentiment(
        self,
        ticker: str
    ) -> float:
        """뉴스 감정 점수 (-1 ~ 1)"""
        pass
    
    ```
    
2. **소셜 트렌드**
    
    ```python
    def analyze_social_trend(
        self,
        ticker: str,
        platforms: List[str] = ["twitter", "reddit"]
    ) -> Dict:
        """소셜미디어 언급 분석"""
        pass
    
    ```
    
3. **공포/탐욕 지수**
    
    ```python
    def calculate_fear_greed_index(self) -> float:
        """시장 심리 지수 (0-100)"""
        pass
    
    ```
    

**입력**

- 종목 코드
- 뉴스/소셜 데이터

**출력**

- 센티먼트 점수
- 트렌드 정보

**서브 에이전트**: 없음

**HITL 개입**: 없음

**구현 복잡도**: ⭐⭐⭐ (Medium-High)

---

## 5. 에이전트 간 상호작용

### 5.1 주요 상호작용 패턴

### 패턴 1: 종목 분석 요청

```
사용자: "삼성전자 분석해줘"
    ↓
마스터 에이전트
    ↓
┌───────────────────────────────┐
│ 병렬 호출:                    │
│ • 개인화 → 사용자 컨텍스트    │
│ • 데이터수집 → 최신 데이터    │
│ • 리서치 → 기업 분석          │
│ • 전략 → Bull/Bear 의견       │
│ • 리스크 → 리스크 평가        │
└───────────────────────────────┘
    ↓
마스터 에이전트 (통합)
    ↓
사용자에게 응답

```

### 패턴 2: 매매 실행

```
사용자: "삼성전자 1000만원어치 매수"
    ↓
마스터 에이전트
    ↓
개인화 에이전트 (프로필 로드)
    ↓
전략 에이전트 (주문 생성)
    ↓
리스크 에이전트 (리스크 체크)
    ↓
[리스크 경고 발생!]
    ↓
마스터 에이전트 (HITL 트리거)
    ↓
사용자 승인 요청
    ↓
[사용자 승인]
    ↓
컴플라이언스 에이전트 (적법성 확인)
    ↓
실행 에이전트 (주문 실행)
    ↓
포트폴리오 에이전트 (포트폴리오 업데이트)
    ↓
결과 반환

```

### 패턴 3: 포트폴리오 리밸런싱

```
사용자: "포트폴리오 리밸런싱"
    ↓
마스터 에이전트
    ↓
포트폴리오 에이전트
    ├─ 현재 vs 목표 비교
    └─ 리밸런싱 계획 생성
    ↓
전략 에이전트
    └─ 매매 계획 검증
    ↓
리스크 에이전트
    └─ 리스크 평가
    ↓
[자동화 레벨에 따라]
    ├─ Lv1: 단순 승인
    ├─ Lv2: 3가지 옵션
    └─ Lv3: 상세 조정
    ↓
실행 에이전트
    └─ 순차적 주문 실행

```

### 5.2 에이전트 간 메시지 프로토콜

```python
@dataclass
class AgentMessage:
    from_agent: str
    to_agent: str
    message_type: str
    payload: Dict
    timestamp: datetime
    request_id: str

# 예시
message = AgentMessage(
    from_agent="master_agent",
    to_agent="strategy_agent",
    message_type="analyze_stock",
    payload={
        "ticker": "005930",
        "user_profile": {...}
    },
    timestamp=datetime.now(),
    request_id="req_12345"
)

```

---

## 6. Phase별 구현 계획

### 6.1 Phase 1 (MVP) - 9개 에이전트

**목표**: 핵심 투자 프로세스 구현

| 에이전트 | 우선순위 | 구현 기간 | 의존성 |
| --- | --- | --- | --- |
| 마스터 | P0 | 2주 | - |
| 데이터 수집 | P0 | 1-2주 | - |
| 리서치 | P0 | 2주 | 데이터 수집 |
| 전략 | P0 | 3주 | 데이터 수집, 리서치 |
| 포트폴리오 | P0 | 3주 | 전략 |
| 리스크 | P0 | 2주 | 포트폴리오 |
| 모니터링 (기본) | P0 | 2주 | 데이터 수집 |
| 교육/질의 | P1 | 1주 | - |
| 개인화 (기본) | P1 | 1주 | - |

**예상 총 기간**: 12-14주 (병렬 작업 고려)

### 6.2 Phase 2 (확장) - 3개 에이전트 추가

**목표**: 실제 매매 연동 및 고도화

| 에이전트 | 우선순위 | 구현 기간 | 의존성 |
| --- | --- | --- | --- |
| 실행 | P0 | 2-3주 | 포트폴리오, 리스크 |
| 개인화 (고도화) | P0 | 2주 | 개인화(기본) |
| 백테스팅 | P1 | 2-3주 | 전략, 포트폴리오 |
| 컴플라이언스 | P1 | 1-2주 | 실행 |
| 모니터링 (고도화) | P1 | 2주 | 모니터링(기본) |

**예상 총 기간**: 8-10주

### 6.3 Phase 3 (미래) - 1개 에이전트 추가

| 에이전트 | 우선순위 | 구현 기간 |
| --- | --- | --- |
| 감정 분석 | P2 | 2-3주 |

---

## 7. 기술 스택

### 7.1 에이전트 프레임워크

```python
# LangGraph 기반 멀티 에이전트 시스템
from langgraph.graph import StateGraph
from langgraph.prebuilt import ToolExecutor

# 에이전트 정의
graph = StateGraph(AgentState)

# 노드 추가
graph.add_node("master", master_agent)
graph.add_node("research", research_agent)
graph.add_node("strategy", strategy_agent)
# ...

# 엣지 정의
graph.add_edge("master", "research")
graph.add_conditional_edges(
    "strategy",
    should_trigger_hitl,
    {
        True: "hitl_approval",
        False: "execution"
    }
)

```

### 7.2 주요 라이브러리

| 용도 | 라이브러리 |
| --- | --- |
| **AI/LLM** | OpenAI API, Anthropic Claude |
| **에이전트 프레임워크** | LangChain, LangGraph |
| **데이터 처리** | pandas, numpy |
| **금융 분석** | QuantLib, TA-Lib |
| **백테스팅** | Backtrader, VectorBT |
| **API 클라이언트** | httpx, aiohttp |
| **캐싱** | Redis |
| **데이터베이스** | PostgreSQL, MongoDB |
| **벡터 DB** | Pinecone, Chroma |

### 7.3 통신 프로토콜

```python
# 에이전트 간 비동기 통신
import asyncio
from typing import Protocol

class Agent(Protocol):
    async def process(
        self,
        input: AgentInput
    ) -> AgentOutput:
        ...

# 메시지 큐 (선택)
from kombu import Connection, Exchange, Queue

# 이벤트 버스
from fastapi_events.dispatcher import dispatch

```

---

## 8. 부록

### 8.1 에이전트 책임 매트릭스

| 기능 | 담당 에이전트 | 역할 |
| --- | --- | --- |
| 의도 분석 | 마스터 | 사용자 질의 해석 |
| 라우팅 | 마스터 | 적절한 에이전트 호출 |
| 데이터 수집 | 데이터 수집 | API 호출 및 캐싱 |
| 기업 분석 | 리서치 | 재무/산업/기술적 분석 |
| 종목 추천 | 전략 | 매매 시그널 생성 |
| 포트폴리오 구성 | 포트폴리오 | 자산 배분 최적화 |
| 리밸런싱 | 포트폴리오 | 리밸런싱 계획 |
| 주문 실행 | 실행 | 증권사 API 호출 |
| 리스크 측정 | 리스크 | 위험도 평가 |
| 가격 모니터링 | 모니터링 | 실시간 추적 |
| 전략 검증 | 백테스팅 | 과거 데이터 시뮬레이션 |
| 규제 준수 | 컴플라이언스 | 적법성 체크 |
| 사용자 학습 | 개인화 | 행동 패턴 분석 |
| 일반 질의 | 교육/질의 | 지식 제공 |

### 8.2 용어 정의

| 용어 | 정의 |
| --- | --- |
| **HITL** | Human-in-the-Loop, 인간 개입 지점 |
| **라우팅** | 적절한 에이전트로 요청 전달 |
| **오케스트레이션** | 여러 에이전트의 조율 |
| **서브 에이전트** | 메인 에이전트 내부의 특화된 에이전트 |
| **트리거** | 특정 조건에서 자동 실행되는 이벤트 |

---

**문서 끝**